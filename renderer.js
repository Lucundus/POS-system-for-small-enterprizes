let products=[],customers=[],cart=[],transactions=[],currentCustomer=null,currentCategoryFilter="All",currentDiscount={value:0,type:"%"},parkedCarts=[],barcodeBuffer="",barcodeTimeout=null;function showAppModal({title:e,message:t,showInput:n,showCancel:r}){return new Promise(o=>{const c=document.getElementById("app-modal"),d=document.getElementById("app-modal-title"),a=document.getElementById("app-modal-message"),s=document.getElementById("app-modal-input"),u=document.getElementById("btn-modal-cancel"),i=document.getElementById("btn-modal-ok");d.innerText=e,a.innerText=t||"",n?(s.classList.remove("hidden"),s.value="",s.focus()):s.classList.add("hidden"),r?u.classList.remove("hidden"):u.classList.add("hidden"),c.classList.remove("hidden");const l=e=>{c.classList.add("hidden"),i.onclick=null,u.onclick=null,s.onkeydown=null,o(e)};i.onclick=()=>l(!n||s.value),u.onclick=()=>l(!!n&&null),s.onkeydown=e=>{"Enter"===e.key&&l(s.value),"Escape"===e.key&&l(null)}})}function appAlert(e){return showAppModal({title:"Alert",message:e,showInput:!1,showCancel:!1})}function appConfirm(e){return showAppModal({title:"Confirm",message:e,showInput:!1,showCancel:!0})}function appPrompt(e){return showAppModal({title:"Input Required",message:e,showInput:!0,showCancel:!0})}const navLinks=document.querySelectorAll(".nav-links li"),views=document.querySelectorAll(".view"),checkoutCustomerInput=document.getElementById("checkout-customer-input"),checkoutCustomerList=document.getElementById("checkout-customers-list"),customerInfoEl=document.getElementById("customer-info"),customerBalanceEl=document.getElementById("customer-balance"),customerLimitEl=document.getElementById("customer-limit"),cartItemsEl=document.getElementById("cart-items"),cartEmptyEl=document.getElementById("cart-empty"),summarySubtotal=document.getElementById("summary-subtotal"),summaryTotal=document.getElementById("summary-total"),btnCheckout=document.getElementById("btn-checkout"),checkoutError=document.getElementById("checkout-error"),productsListEl=document.getElementById("products-list"),addProductForm=document.getElementById("add-product-form"),btnShowAddProduct=document.getElementById("btn-show-add-product"),btnCancelProduct=document.getElementById("btn-cancel-product"),btnAddProduct=document.getElementById("btn-add-product"),customersListEl=document.getElementById("customers-list"),addCustomerForm=document.getElementById("add-customer-form"),btnShowAddCustomer=document.getElementById("btn-show-add-customer"),btnCancelCustomer=document.getElementById("btn-cancel-customer"),btnAddCustomer=document.getElementById("btn-add-customer"),formatMoney=e=>`$${parseFloat(e).toFixed(2)}`;async function initApp(){await loadProducts(),await loadCustomers(),await loadTransactions(),setupNavigation(),setupEventListeners(),setupBarcodeScanner()}async function loadProducts(){products=await window.api.getProducts(),renderProductsList(),renderQuickItemCategories(),renderQuickItems(document.getElementById("quick-items-search")?document.getElementById("quick-items-search").value:"")}async function loadCustomers(){customers=await window.api.getCustomers(),renderCustomersList(),populateCheckoutCustomers(),currentCustomer&&(currentCustomer=customers.find(e=>e.Id===currentCustomer.Id),currentCustomer?(customerBalanceEl.innerText=formatMoney(currentCustomer.Balance),customerLimitEl.innerText=formatMoney(currentCustomer.CreditLimit),customerBalanceEl.className="value "+(currentCustomer.Balance<0?"balance-negative":"")):(checkoutCustomerInput.value="",customerInfoEl.classList.add("hidden")))}async function loadTransactions(){transactions=await window.api.getTransactions(),renderTransactionsList()}function renderProductsList(){productsListEl.innerHTML="",products.forEach(e=>{productsListEl.innerHTML+=`\n            <tr>\n                <td>${e.Barcode.startsWith("SYS_NO_BARCODE_")?"<i>Quick Item</i>":e.Barcode}</td>\n                <td>${e.Name}</td>\n                <td>${formatMoney(e.Price)}</td>\n                <td class="table-actions">\n                    <button class="btn btn-secondary btn-sm" onclick="editProduct(${e.Id})">Edit</button>\n                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${e.Id})">Delete</button>\n                </td>\n            </tr>\n        `})}function renderCustomersList(){customersListEl.innerHTML="",customers.forEach(e=>{const t=e.Balance<0?"balance-negative":"";customersListEl.innerHTML+=`\n            <tr>\n                <td>${e.Name}</td>\n                <td class="${t}">${formatMoney(e.Balance)}</td>\n                <td>${formatMoney(e.CreditLimit)}</td>\n                <td class="table-actions">\n                    <button class="btn btn-secondary btn-sm" onclick="editCustomer(${e.Id})">Edit</button>\n                    <button class="btn btn-success btn-sm" onclick="addPayment(${e.Id}, '${e.Name}')">Payment</button>\n                    <button class="btn btn-primary btn-sm" style="background-color: var(--accent-primary);" onclick="exportCustomer(${e.Id}, '${e.Name}')">Export</button>\n                    <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${e.Id})">Delete</button>\n                </td>\n            </tr>\n        `})}function renderQuickItems(e=""){const t=document.getElementById("quick-items-grid");t&&(t.innerHTML="",products.filter(t=>{const n=t.Barcode.startsWith("SYS_NO_BARCODE_"),r=t.Name.toLowerCase().includes(e.toLowerCase()),o=t.Category||"General";return n&&r&&("All"===currentCategoryFilter||o===currentCategoryFilter)}).forEach(e=>{const n=document.createElement("button");n.className="quick-item-btn",n.innerHTML=`\n            <span class="quick-item-name">${e.Name}</span>\n            <span class="quick-item-price">${formatMoney(e.Price)}</span>\n        `,n.onclick=()=>addToCart(e),t.appendChild(n)}))}function renderQuickItemCategories(){const e=document.getElementById("quick-items-categories");if(!e)return;const t=products.filter(e=>e.Barcode.startsWith("SYS_NO_BARCODE_")),n=new Set;t.forEach(e=>{const t=e.Category||"General";n.add(t)});const r=["All",...Array.from(n).sort()];e.innerHTML="",r.forEach(t=>{const n=document.createElement("button");n.className="category-tab "+(t===currentCategoryFilter?"active":""),n.innerText=t,n.onclick=()=>{currentCategoryFilter=t,renderQuickItemCategories(),renderQuickItems(document.getElementById("quick-items-search").value)},e.appendChild(n)})}function populateCheckoutCustomers(){checkoutCustomerList.innerHTML="",customers.forEach(e=>{checkoutCustomerList.innerHTML+=`<option value="${e.Name}">Balance: ${formatMoney(e.Balance)}</option>`})}function renderTransactionsList(e=""){const t=document.getElementById("transactions-list");t.innerHTML="",transactions.filter(t=>(t.CustomerName||"CASH CUSTOMER").toLowerCase().includes(e.toLowerCase())).forEach(e=>{t.innerHTML+=`\n            <tr>\n                <td>${new Date(e.Date).toLocaleString()}</td>\n                <td>${e.CustomerName||"CASH CUSTOMER"}</td>\n                <td>${e.Type}</td>\n                <td style="font-weight: 600;">${formatMoney(e.TotalAmount)}</td>\n                <td class="table-actions">\n                    <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${e.Id})">Delete</button>\n                </td>\n            </tr>\n        `})}function addToCart(e){const t=cart.find(t=>t.product.Id===e.Id);t?t.quantity+=1:cart.push({product:e,quantity:1}),renderCart()}function updateCartQty(e,t){cart[e].quantity+=t,cart[e].quantity<=0&&cart.splice(e,1),renderCart()}function renderCart(){cartItemsEl.innerHTML="",0===cart.length?cartEmptyEl.classList.remove("hidden"):cartEmptyEl.classList.add("hidden");let e=0;cart.forEach((t,n)=>{const r=t.product.Price*t.quantity;e+=r,cartItemsEl.innerHTML+=`\n            <tr>\n                <td>${t.product.Name}</td>\n                <td>${formatMoney(t.product.Price)}</td>\n                <td style="text-align: center;">\n                    <div class="qty-control" style="justify-content: center; gap: 12px;">\n                        <button class="btn btn-secondary" style="width: 32px; height: 32px; padding: 0; font-size: 18px; line-height: 1;" onclick="updateCartQty(${n}, -1)">-</button>\n                        <span style="font-size: 16px; font-weight: 500; min-width: 20px; text-align: center;">${t.quantity}</span>\n                        <button class="btn btn-primary" style="width: 32px; height: 32px; padding: 0; font-size: 18px; line-height: 1;" onclick="updateCartQty(${n}, 1)">+</button>\n                    </div>\n                </td>\n                <td style="font-weight: 600; text-align: right;">${formatMoney(r)}</td>\n                <td style="text-align: center;"><button class="btn btn-danger" style="width: 32px; height: 32px; padding: 0; font-size: 16px;" onclick="cart.splice(${n}, 1); renderCart();">X</button></td>\n            </tr>\n        `});let t=0;currentDiscount.value>0&&(t="%"===currentDiscount.type?e*(currentDiscount.value/100):currentDiscount.value),t>e&&(t=e);const n=e-t;summarySubtotal.innerText=formatMoney(e);const r=document.getElementById("summary-discount");t>0?(r.innerText="-"+formatMoney(t),r.classList.remove("hidden")):r.classList.add("hidden"),summaryTotal.innerText=formatMoney(n)}function renderParkedCarts(){const e=document.getElementById("parked-carts-container");e&&(e.innerHTML="",parkedCarts.forEach((t,n)=>{const r=document.createElement("button");r.className="btn btn-secondary btn-sm",r.style.backgroundColor="var(--bg-dark)",r.style.border="1px solid var(--border-color)",r.style.color="var(--text-main)";let o=`Cart ${n+1}`;t.customer?o+=` - ${t.customer.Name}`:o+=" - Cash",r.innerText=o,r.onclick=async()=>{if(cart.length>0&&!await appConfirm("You have an active cart. Resuming will overwrite it. Proceed?"))return;const e=parkedCarts.splice(n,1)[0];cart=e.cart,currentCustomer=e.customer,currentDiscount=e.discount,currentCustomer?(checkoutCustomerInput.value=currentCustomer.Name,customerBalanceEl.innerText=formatMoney(currentCustomer.Balance),customerLimitEl.innerText=formatMoney(currentCustomer.CreditLimit),customerBalanceEl.className="value "+(currentCustomer.Balance<0?"balance-negative":""),customerInfoEl.classList.remove("hidden")):(checkoutCustomerInput.value="",customerInfoEl.classList.add("hidden")),currentDiscount.value>0?(document.getElementById("discount-inputs").classList.remove("hidden"),document.getElementById("btn-toggle-discount").innerText="- Hide Discount",document.getElementById("discount-val").value=currentDiscount.value,document.getElementById("discount-type").value=currentDiscount.type):(document.getElementById("discount-inputs").classList.add("hidden"),document.getElementById("btn-toggle-discount").innerText="+ Add Discount",document.getElementById("discount-val").value=""),renderCart(),renderParkedCarts()},e.appendChild(r)}))}function setupEventListeners(){document.getElementById("quick-items-search").addEventListener("input",e=>{renderQuickItems(e.target.value)});const e=document.getElementById("btn-toggle-discount"),t=document.getElementById("discount-inputs"),n=document.getElementById("discount-val"),r=document.getElementById("discount-type");e.addEventListener("click",()=>{t.classList.contains("hidden")?(t.classList.remove("hidden"),e.innerText="- Hide Discount"):(t.classList.add("hidden"),e.innerText="+ Add Discount",currentDiscount={value:0,type:"%"},n.value="",renderCart())}),n.addEventListener("input",e=>{currentDiscount.value=parseFloat(e.target.value)||0,renderCart()}),r.addEventListener("change",e=>{currentDiscount.type=e.target.value,renderCart()}),checkoutCustomerInput.addEventListener("change",e=>{const t=e.target.value.trim();t?(currentCustomer=customers.find(e=>e.Name===t),currentCustomer?(customerBalanceEl.innerText=formatMoney(currentCustomer.Balance),customerLimitEl.innerText=formatMoney(currentCustomer.CreditLimit),customerBalanceEl.className="value "+(currentCustomer.Balance<0?"balance-negative":""),customerInfoEl.classList.remove("hidden")):(currentCustomer=null,customerInfoEl.classList.add("hidden"))):(currentCustomer=null,customerInfoEl.classList.add("hidden")),checkoutError.classList.add("hidden")}),document.getElementById("btn-clear-cart").addEventListener("click",async()=>{(0!==cart.length||currentCustomer)&&await appConfirm("Are you sure you want to clear the cart and discard current changes?")&&(cart=[],currentCustomer=null,currentDiscount={value:0,type:"%"},checkoutCustomerInput.value="",customerInfoEl.classList.add("hidden"),document.getElementById("discount-inputs").classList.add("hidden"),document.getElementById("btn-toggle-discount").innerText="+ Add Discount",document.getElementById("discount-val").value="",checkoutError.classList.add("hidden"),renderCart())}),document.getElementById("btn-hold-cart").addEventListener("click",()=>{0!==cart.length&&(parkedCarts.push({id:Date.now(),customer:currentCustomer,cart:[...cart],discount:{...currentDiscount}}),cart=[],currentCustomer=null,currentDiscount={value:0,type:"%"},checkoutCustomerInput.value="",customerInfoEl.classList.add("hidden"),document.getElementById("discount-inputs").classList.add("hidden"),document.getElementById("btn-toggle-discount").innerText="+ Add Discount",document.getElementById("discount-val").value="",checkoutError.classList.add("hidden"),renderCart(),renderCart(),renderParkedCarts())}),btnCheckout.addEventListener("click",async()=>{if(0===cart.length)return;checkoutError.classList.add("hidden");const e=cart.reduce((e,t)=>e+t.product.Price*t.quantity,0);let t=e;currentDiscount.value>0&&("%"===currentDiscount.type?t-=e*(currentDiscount.value/100):t-=currentDiscount.value),t<0&&(t=0);const n={customerId:currentCustomer?currentCustomer.Id:null,totalAmount:t,items:cart.map(e=>({productId:e.product.Id,quantity:e.quantity,price:e.product.Price}))},r=await window.api.processCheckout(n);r.success?(cart=[],currentDiscount={value:0,type:"%"},document.getElementById("discount-val").value="",document.getElementById("discount-inputs").classList.add("hidden"),document.getElementById("btn-toggle-discount").innerText="+ Add Discount",renderCart(),await loadCustomers(),await loadTransactions(),btnCheckout.innerText="Success!",btnCheckout.classList.replace("btn-primary","btn-success"),setTimeout(()=>{btnCheckout.innerText="Complete Sale",btnCheckout.classList.replace("btn-success","btn-primary")},2e3),checkoutCustomerInput.value="",checkoutCustomerInput.dispatchEvent(new Event("change"))):(checkoutError.innerText=r.error,checkoutError.classList.remove("hidden"))}),window.editProduct=e=>{const t=products.find(t=>t.Id===e);t&&(document.getElementById("product-form-title").innerText="Edit Product",document.getElementById("prod-id").value=t.Id,document.getElementById("prod-barcode").value=t.Barcode.startsWith("SYS_NO_BARCODE_")?"":t.Barcode,document.getElementById("prod-name").value=t.Name,document.getElementById("prod-price").value=t.Price,document.getElementById("prod-category").value=t.Category||"General",document.getElementById("prod-error").classList.add("hidden"),addProductForm.classList.remove("hidden"),document.getElementById("prod-name").focus())},document.getElementById("btn-import-products").addEventListener("click",async()=>{const e=document.getElementById("btn-import-products"),t=e.innerText;e.innerText="Importing...";const n=await window.api.importProductsExcel();if(n.error)await appAlert(n.error);else if(n.success){let e=`Successfully imported ${n.count} products!`;n.duplicates>0&&(e+=`\nSkipped ${n.duplicates} existing barcodes.`),await appAlert(e),await loadProducts()}e.innerText=t}),btnShowAddProduct.addEventListener("click",()=>{document.getElementById("product-form-title").innerText="Add Product",document.getElementById("prod-id").value="",document.getElementById("prod-barcode").value="",document.getElementById("prod-name").value="",document.getElementById("prod-price").value="",document.getElementById("prod-category").value="General",document.getElementById("prod-error").classList.add("hidden"),addProductForm.classList.remove("hidden"),document.getElementById("prod-barcode").focus()}),btnCancelProduct.addEventListener("click",()=>{addProductForm.classList.add("hidden"),document.getElementById("prod-error").classList.add("hidden")}),btnAddProduct.addEventListener("click",async()=>{const e=document.getElementById("prod-id").value,t=document.getElementById("prod-barcode").value.trim(),n=document.getElementById("prod-name").value.trim(),r=document.getElementById("prod-price").value,o=document.getElementById("prod-category").value.trim()||"General",c=document.getElementById("prod-error");if(c.classList.add("hidden"),!n||!r)return c.innerText="Name and Price are required.",void c.classList.remove("hidden");const d={id:e,barcode:t,name:n,price:r,category:o};let a;a=e?await window.api.updateProduct(d):await window.api.addProduct(d),a.error?(c.innerText=a.error,c.classList.remove("hidden")):(document.getElementById("prod-id").value="",document.getElementById("prod-barcode").value="",document.getElementById("prod-name").value="",document.getElementById("prod-price").value="",addProductForm.classList.add("hidden"),await loadProducts())}),window.editCustomer=e=>{const t=customers.find(t=>t.Id===e);t&&(document.getElementById("customer-form-title").innerText="Edit Customer",document.getElementById("cust-id").value=t.Id,document.getElementById("cust-name").value=t.Name,document.getElementById("cust-balance").value=t.Balance,document.getElementById("cust-limit").value=t.CreditLimit,document.getElementById("cust-error").classList.add("hidden"),addCustomerForm.classList.remove("hidden"),document.getElementById("cust-name").focus())},document.getElementById("btn-import-customers").addEventListener("click",async()=>{const e=document.getElementById("btn-import-customers");e.innerText="Importing...";const t=await window.api.importCustomersExcel();t.error?await appAlert(t.error):t.success&&(await appAlert(`Successfully imported ${t.count} customers!`),await loadCustomers()),e.innerText="Import Excel"}),document.getElementById("btn-export-all-customers").addEventListener("click",async()=>{const e=document.getElementById("btn-export-all-customers"),t=e.innerText;e.innerText="Exporting...";const n=await window.api.exportAllCustomers();n.error?await appAlert(n.error):n.success&&await appAlert("All customers exported successfully to:\n"+n.filePath),e.innerText=t}),document.getElementById("transaction-search").addEventListener("keyup",e=>{renderTransactionsList(e.target.value)}),btnShowAddCustomer.addEventListener("click",()=>{document.getElementById("customer-form-title").innerText="Add Customer",document.getElementById("cust-id").value="",document.getElementById("cust-name").value="",document.getElementById("cust-balance").value="0",document.getElementById("cust-limit").value="-3000",document.getElementById("cust-error").classList.add("hidden"),addCustomerForm.classList.remove("hidden"),document.getElementById("cust-name").focus()}),btnCancelCustomer.addEventListener("click",()=>{addCustomerForm.classList.add("hidden"),document.getElementById("cust-error").classList.add("hidden")}),btnAddCustomer.addEventListener("click",async()=>{const e=document.getElementById("cust-id").value,t=document.getElementById("cust-name").value.trim(),n=document.getElementById("cust-balance").value,r=document.getElementById("cust-limit").value,o=document.getElementById("cust-error");if(o.classList.add("hidden"),!t)return o.innerText="Customer Name is required.",void o.classList.remove("hidden");const c={id:e,name:t,balance:n,creditLimit:r};let d=e?await window.api.updateCustomer(c):await window.api.addCustomer(c);d.error?(o.innerText=d.error,o.classList.remove("hidden")):(document.getElementById("cust-id").value="",document.getElementById("cust-name").value="",document.getElementById("cust-balance").value="0",document.getElementById("cust-limit").value="-3000",addCustomerForm.classList.add("hidden"),await loadCustomers())})}function setupBarcodeScanner(){document.addEventListener("keydown",async e=>{if(document.getElementById("checkout-view").classList.contains("active")&&!["INPUT","TEXTAREA"].includes(e.target.tagName))if("Enter"===e.key){if(barcodeBuffer.length>0){const e=await window.api.getProductByBarcode(barcodeBuffer);e?addToCart(e):await appConfirm(`Product with barcode ${barcodeBuffer} not found.\nWould you like to add it now?`)&&(document.querySelector('[data-view="products"]').click(),btnShowAddProduct.click(),setTimeout(()=>{document.getElementById("prod-barcode").value=barcodeBuffer,document.getElementById("prod-name").focus()},50)),barcodeBuffer=""}}else 1===e.key.length&&(barcodeBuffer+=e.key,clearTimeout(barcodeTimeout),barcodeTimeout=setTimeout(()=>{barcodeBuffer=""},100))})}function setupNavigation(){navLinks.forEach(e=>{e.addEventListener("click",()=>{navLinks.forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.getAttribute("data-view")+"-view";views.forEach(e=>e.classList.remove("active")),document.getElementById(t).classList.add("active"),checkoutError&&"checkout-view"!==t&&checkoutError.classList.add("hidden")})})}window.deleteProduct=async e=>{await appConfirm("Are you sure you want to delete this product?")&&(await window.api.deleteProduct(e),await loadProducts())},window.deleteCustomer=async e=>{await appConfirm("Are you sure you want to delete this customer?")&&(await window.api.deleteCustomer(e),await loadCustomers())},window.addPayment=async(e,t)=>{const n=await appPrompt("Enter payment amount for "+t+":");if(n&&!isNaN(n)&&Number(n)>0){const t=await window.api.processPayment({customerId:e,amount:Number(n)});t.error?await appAlert(t.error):(await loadCustomers(),await loadTransactions())}},window.exportCustomer=async(e,t)=>{const n=event.target;n.innerText="Exporting...";const r=await window.api.exportCustomerHistory(e,t);r.error?await appAlert(r.error):r.success&&await appAlert("Exported successfully to:\n"+r.filePath),n.innerText="Export"},initApp();